{% extends "base.html" %}

{% block title %}Photobooth{% endblock %}

{% block content %}
<div class="container-fluid p-3" style="height: 100vh; overflow: hidden; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: #1a1a1a;">
    <!-- Bouton restart discret en haut à gauche -->
    <button onclick="restartKiosk()" 
            class="btn btn-sm btn-outline-secondary position-fixed" 
            style="top: 10px; left: 10px; z-index: 30; opacity: 0.3; border-radius: 5px; padding: 5px 10px;"
            title="Redémarrer le kiosque"
            onmouseover="this.style.opacity='1'" 
            onmouseout="this.style.opacity='0.3'">
        <i class="fas fa-sync-alt"></i>
    </button>
    
    <style>
    /* Ajustements spécifiques pour les petits écrans 800x480 */
    @media (max-width: 800px) and (max-height: 480px) {
        #videoContainer {
            height: calc(100vh - 1rem);
            width: calc(100vw - 1rem);
        }

        #videoPreview {
            max-width: calc(100vw - 1rem);
            max-height: calc(100vh - 1rem);
        }

        #captureBtn {
            font-size: 1.2rem;
            padding: 8px 16px;
        }
    }
    </style>
    <!-- Conteneur vidéo avec marges élégantes -->
    <div class="video-container position-relative d-flex align-items-center justify-content-center" id="videoContainer" style="height: calc(100vh - 2rem); width: calc(100vw - 2rem);">
        <img id="videoPreview" 
             src="{{ url_for('video_stream') }}" 
             style="max-width: calc(100vw - 2rem); max-height: calc(100vh - 2rem); width: auto; height: auto; object-fit: contain; background-color: #000; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);"
             alt="Flux vidéo caméra">
        
        <!-- Countdown overlay -->
        <div class="countdown d-none position-absolute top-50 start-50 translate-middle" id="countdown"></div>
        
        <!-- Flash blanc pour la prise de photo -->
        <div class="flash-overlay d-none position-fixed top-0 start-0 w-100 h-100" id="flashOverlay" 
             style="background-color: white; z-index: 15; display: flex; align-items: center; justify-content: center;">
            <div style="font-size: 8rem; font-weight: bold; color: black; text-shadow: none;">CHEESE!</div>
        </div>
        
        <!-- Bouton capture en overlay -->
        <div class="position-absolute bottom-0 start-50 translate-middle-x mb-4" style="z-index: 5;">
            <button id="captureBtn" class="btn btn-danger btn-lg px-5 py-3" onclick="capturePhoto()" 
                    style="font-size: 1.5rem; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                <i class="fas fa-camera fa-2x"></i>
            </button>
        </div>
    </div>
    
    <!-- Alerte manque de papier -->
    <div class="position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 20; width: 90%; max-width: 500px;">
        <div class="alert alert-warning d-none d-flex align-items-center" id="paper-alert" style="border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <div>
                <strong>Attention !</strong><br>
                <small>Vérifiez le papier de l'imprimante avant de prendre une photo</small>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let isCapturing = false;

// Initialiser la caméra au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    initCamera();
});

// Fonction pour initialiser la caméra
function initCamera() {
    // Démarrer le flux caméra si nécessaire
    fetch('/start_camera').catch(error => {
        console.log('Erreur démarrage caméra:', error);
    });
}

// Fonction de capture de photo
function capturePhoto() {
    if (isCapturing) return;
    isCapturing = true;
    
    const countdownElement = document.getElementById('countdown');
    const flashOverlay = document.getElementById('flashOverlay');
    const captureBtn = document.getElementById('captureBtn');
    
    // Désactiver le bouton
    captureBtn.disabled = true;
    captureBtn.innerHTML = '<i class="fas fa-spinner fa-spin fa-2x"></i>';
    
    // Countdown
    let count = {{ timer }};
    countdownElement.classList.remove('d-none');
    countdownElement.innerHTML = `<div style="font-size: 10rem; font-weight: bold; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">${count}</div>`;
    
    const countdownInterval = setInterval(() => {
        count--;
        if (count > 0) {
            countdownElement.innerHTML = `<div style="font-size: 10rem; font-weight: bold; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">${count}</div>`;
        } else {
            clearInterval(countdownInterval);
            countdownElement.classList.add('d-none');
            
            // Flash
            flashOverlay.classList.remove('d-none');
            setTimeout(() => {
                flashOverlay.classList.add('d-none');
                
                // Capture
                fetch('/capture', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Rediriger vers la page de révision
                            window.location.href = `/review?photo=${data.filename}`;
                        } else {
                            alert('Erreur de capture: ' + (data.error || 'Erreur inconnue'));
                            resetCaptureButton();
                        }
                    })
                    .catch(error => {
                        console.error('Erreur capture:', error);
                        alert('Erreur de capture');
                        resetCaptureButton();
                    });
            }, 200);
        }
    }, 1000);
}

// Fonction pour réinitialiser le bouton de capture
function resetCaptureButton() {
    const captureBtn = document.getElementById('captureBtn');
    captureBtn.disabled = false;
    captureBtn.innerHTML = '<i class="fas fa-camera fa-2x"></i>';
    isCapturing = false;
}

// Vérifier le statut de l'imprimante pour l'alerte papier
function checkPrinterPaperStatus() {
    fetch('/api/printer_status')
        .then(response => response.json())
        .then(data => {
            const paperAlert = document.getElementById('paper-alert');
            
            // Afficher l'alerte seulement si l'imprimante est activée et qu'il y a un problème de papier
            if (data.status === 'ok' && data.paper_status && data.paper_status !== 'ok' && data.paper_status !== 'unknown') {
                paperAlert.classList.remove('d-none');
            } else {
                paperAlert.classList.add('d-none');
            }
        })
        .catch(error => {
            console.error('Erreur vérification papier:', error);
            // Masquer l'alerte en cas d'erreur
            document.getElementById('paper-alert').classList.add('d-none');
        });
}

// Vérifier le papier au chargement et périodiquement
document.addEventListener('DOMContentLoaded', function() {
    // Vérifier si on doit forcer l'affichage de l'alerte papier
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('show_paper_alert') === '1') {
        // Forcer l'affichage de l'alerte
        const paperAlert = document.getElementById('paper-alert');
        paperAlert.classList.remove('d-none');
        
        // Nettoyer l'URL sans recharger la page
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
    }
    
    checkPrinterPaperStatus();
    // Vérifier toutes les 5 minutes au lieu de 30 secondes pour éviter de spammer l'imprimante
    setInterval(checkPrinterPaperStatus, 300000); // 5 minutes
});

// Fonction pour redémarrer le service kiosk
function restartKiosk() {
    fetch('/restart_kiosk', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Le kiosque va redémarrer, pas besoin d'alerte
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
    });
}

// Nettoyer les ressources lors de la fermeture
window.addEventListener('beforeunload', function() {
    fetch('/stop_camera').catch(error => {
        console.log('Erreur arrêt caméra:', error);
    });
});
</script>
{% endblock %}
